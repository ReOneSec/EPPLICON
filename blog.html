<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog | Epplicon Technologies</title>
    <link rel="icon" href="https://i.ibb.co/Vc8SbKH3/Picsart-25-06-12-13-49-11-841.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- External Stylesheets -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/animations.css">
    <link rel="stylesheet" href="assets/css/advanced.css">
    
    <style>
        /* --- Import main theme variables --- */
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #0a192f;
            --background-color: #f5f7fa;
            --surface-color: #ffffff;
            --text-primary: #1e2a3a;
            --text-secondary: #5a6473;
            --border-color: #e9ecef;
            --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.1);
            --transition-smooth: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Dark Mode Colors */
        [data-theme="dark"] {
            --primary-color: #4dabf7;
            --secondary-color: #1a1a2e;
            --background-color: #0f0f1e;
            --surface-color: #16213e;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --border-color: #27272a;
            --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.5);
        }

        /* --- Global Styles (from your main site) --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.8;
            font-size: 17px;
        }
        .container {
            width: 90%;
            max-width: 1180px;
            margin: 0 auto;
        }
        h1, h2, h3, h4 {
            font-weight: 700;
            color: var(--secondary-color);
            line-height: 1.3;
        }
        p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }
        .btn {
            display: inline-block;
            padding: 12px 28px;
            background-image: linear-gradient(45deg, var(--primary-color) 0%, #0056b3 100%);
            color: #fff;
            text-decoration: none;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 20px rgba(13, 110, 253, 0.3);
            text-align: center;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(13, 110, 253, 0.4);
        }
        .hidden { display: none; }

        /* --- Re-using Header/Footer from your main site (basic styles) --- */
        .main-header {
            background: var(--surface-color);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
            opacity: 0.95;
        }
        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 2rem;
            font-weight: 800;
            text-decoration: none;
            color: var(--secondary-color);
        }
        .desktop-nav { display: flex; align-items: center; }
        .desktop-nav a {
            text-decoration: none;
            color: var(--text-primary);
            margin-left: 35px;
            font-weight: 500;
        }
        .desktop-nav a.contact-btn {
            background-color: var(--primary-color);
            color: #fff;
            padding: 8px 20px;
            border-radius: 6px;
        }
        /* Mobile Navigation */
        .mobile-nav-toggle {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 1001;
            padding: 10px;
        }
        .mobile-nav-toggle .icon-bar {
            display: block;
            width: 25px;
            height: 3px;
            background-color: var(--secondary-color);
            margin: 5px 0;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .mobile-nav-toggle.active .icon-bar:nth-child(1) {
            transform: translateY(8px) rotate(45deg);
        }
        .mobile-nav-toggle.active .icon-bar:nth-child(2) {
            opacity: 0;
        }
        .mobile-nav-toggle.active .icon-bar:nth-child(3) {
            transform: translateY(-8px) rotate(-45deg);
        }
        .mobile-nav {
            position: fixed;
            top: 0;
            left: 100%;
            width: 100%;
            height: 100vh;
            background-color: var(--secondary-color);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: left 0.5s cubic-bezier(0.77, 0, 0.175, 1);
            opacity: 0.95;
        }
        .mobile-nav.active {
            left: 0;
        }
        .mobile-nav a {
            color: #fff;
            text-decoration: none;
            font-size: 1.8rem;
            font-weight: 500;
            margin: 1.5rem 0;
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .mobile-nav.active a {
            transform: translateY(0);
            opacity: 1;
            transition-delay: 0.3s;
        }
        body.mobile-nav-active {
            overflow: hidden;
        }
        .site-footer {
            background: var(--secondary-color);
            color: #fff;
            padding-top: 60px;
        }
        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr;
            gap: 2rem;
            padding-bottom: 40px;
        }
        .footer-grid h4 { color: #fff; margin-bottom: 1rem; }
        .footer-grid p, .footer-grid a { color: rgba(255,255,255,0.7); text-decoration: none; }
        .footer-grid ul { list-style: none; }
        .footer-grid li { margin-bottom: 0.5rem; }
        .footer-bottom {
            border-top: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            padding: 25px 0;
        }

        /* --- Blog Specific Styles --- */
        .blog-hero {
            padding-top: 160px;
            padding-bottom: 60px;
            text-align: center;
        }
        .blog-hero h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
        }
        .blog-hero p {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 1rem auto 0 auto;
        }

        /* Category Filter */
        .category-filter {
            padding: 2rem 0;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 60px;
        }
        .category-filter .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
        }
        .category-link {
            text-decoration: none;
            color: var(--text-secondary);
            background: var(--surface-color);
            padding: 8px 18px;
            border-radius: 20px;
            font-weight: 500;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        .category-link:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .category-link.active {
            background: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
        }

        .blog-grid-section {
            padding: 0 0 100px 0;
        }

        .blog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2.5rem;
        }

        /* Re-using 'work-card' styles for the blog card */
        .blog-card {
            background: var(--surface-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-smooth);
            border: 1px solid var(--border-color);
            text-decoration: none;
            display: flex;
            flex-direction: column;
        }
        .blog-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-md);
        }
        .blog-card-image {
            height: 250px;
            overflow: hidden;
            background-color: var(--border-color);
        }
        .blog-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease-in-out;
        }
        .blog-card:hover .blog-card-image img {
            transform: scale(1.05);
        }
        .blog-card-content {
            padding: 25px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .blog-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .blog-card-tag {
            color: var(--primary-color);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.8rem;
        }
        .blog-card-content h3 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
        }
        .blog-card-content p {
            color: var(--text-secondary);
            font-size: 1rem;
            flex-grow: 1;
            margin-bottom: 1rem;
        }
        .blog-card-footer {
            margin-top: auto;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Pagination */
        .pagination-container {
            text-align: center;
            margin-top: 4rem;
        }

        /* Loading Spinner */
        .spinner {
            border: 5px solid rgba(0,0,0,0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 5rem auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .desktop-nav { display: none; }
            .mobile-nav-toggle { display: block; }
        }
        @media (max-width: 768px) {
            .footer-grid {
                grid-template-columns: 1fr;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    
    <!-- Header -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    <div id="preloader">
        <div class="spinner"></div>
    </div>

    <div id="nav-placeholder"></div>

    <main id="main-content">
        <section class="blog-hero">
            <div class="container">
                <h1 id="page-title">Insights & Articles</h1>
                <p id="page-description">Welcome to our hub for ideas, tutorials, and perspectives on technology, design, and digital innovation.</p>
            </div>
        </section>

        <!-- Blog Search Section -->
        <section style="padding: 2rem 0; background-color: var(--surface-color);">
            <div class="container">
                <div class="blog-search">
                    <input type="text" id="blogSearchInput" placeholder="Search articles by title, content, or tags...">
                    <button type="button" id="blogSearchBtn" aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Category Filter Section -->
        <section class="category-filter">
            <div class="container" id="category-filter-container">
                <!-- Categories will be loaded here by JS -->
                <div id="category-loader" class="spinner" style="margin: 0; width: 20px; height: 20px;"></div>
            </div>
        </section>

        <section class="blog-grid-section">
            <div class="container">
                <!-- This is where the blog posts will be loaded -->
                <div id="blog-grid-container" class="blog-grid">
                    <!-- Loading Spinner -->
                    <div id="loader" class="spinner"></div>
                    <!-- Error message container -->
                    <div id="error-message" class="hidden" style="color: var(--danger-color); text-align: center; grid-column: 1 / -1;"></div>
                    <!-- No posts message container -->
                    <div id="no-posts" class="hidden" style="text-align: center; grid-column: 1 / -1;"></div>
                </div>
                
                <!-- Pagination -->
                <div class="pagination-container">
                    <button id="load-more-btn" class="btn hidden">Load More Posts</button>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <!-- DOMPurify for HTML Sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs,
            query,
            where,
            orderBy,
            limit,
            startAfter
            // **FIX:** Removed the non-existent 'getCount' import
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Import our config file
        import { firebaseConfig_DB_AUTH } from './config.js';

        // --- DOM Elements ---
        const blogGrid = document.getElementById('blog-grid-container');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const noPostsMessage = document.getElementById('no-posts');
        const categoryFilterContainer = document.getElementById('category-filter-container');
        const categoryLoader = document.getElementById('category-loader');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const pageTitle = document.getElementById('page-title');
        
        // --- App State ---
        let db;
        let postsCollection, categoriesCollection;
        let lastVisiblePost = null; // For pagination
        let currentCategorySlug = null;
        let categoriesMap = new Map(); // Cache for category data
        const POSTS_PER_PAGE = 9; // Number of posts to load at a time
        let currentQuery; // To store the query for pagination

        /**
         * 1. MAIN INITIALIZATION
         * Initializes Firebase and loads both categories and the first page of posts.
         */
        async function initializeAppAndLoad() {
            try {
                // Initialize the Firebase app (Project 1)
                const dbApp = initializeApp(firebaseConfig_DB_AUTH, "dbApp");
                db = getFirestore(dbApp);
                postsCollection = collection(db, 'posts');
                categoriesCollection = collection(db, 'categories');

                console.log("Firebase services initialized.");

                // Check for a category filter in the URL
                const params = new URLSearchParams(window.location.search);
                currentCategorySlug = params.get('category');

                // Load categories first (for the filter bar)
                await loadCategories();
                
                // Then load the first page of posts
                await loadPosts(true); // true = initial load

            } catch (error) {
                console.error("CRITICAL ERROR initializing app:", error);
                loader.classList.add('hidden');
                categoryLoader.classList.add('hidden');
                showError("Failed to initialize. Check console.");
            }
        }
        
        /**
         * Loads all categories for the filter bar.
         */
        async function loadCategories() {
            try {
                const q = query(categoriesCollection, orderBy("name"));
                const querySnapshot = await getDocs(q);
                
                categoryFilterContainer.innerHTML = ''; // Clear loader
                
                // Add "All Posts" link
                const allLink = document.createElement('a');
                allLink.href = 'blog.html';
                allLink.className = 'category-link';
                allLink.textContent = 'All Posts';
                if (!currentCategorySlug) {
                    allLink.classList.add('active');
                }
                categoryFilterContainer.appendChild(allLink);
                
                // Add a link for each category
                querySnapshot.forEach(doc => {
                    const category = doc.data();
                    categoriesMap.set(category.slug, {id: doc.id, name: category.name}); // Save slug->id mapping
                    
                    const catLink = document.createElement('a');
                    catLink.href = `blog.html?category=${category.slug}`;
                    catLink.className = 'category-link';
                    catLink.textContent = category.name;
                    
                    if (currentCategorySlug === category.slug) {
                        catLink.classList.add('active');
                        pageTitle.textContent = `Category: ${category.name}`;
                    }
                    categoryFilterContainer.appendChild(catLink);
                });
                
            } catch (error) {
                console.error("Error loading categories:", error);
                categoryFilterContainer.innerHTML = '<p style="color: var(--danger-color)">Error loading categories</p>';
            }
        }

        /**
         * Builds the correct query based on filters
         */
        async function buildQuery() {
            // Base constraints: Published, ordered by date
            let constraints = [
                where("isPublished", "==", true),
                orderBy("createdAt", "desc")
            ];

            // Add category filter if present
            if (currentCategorySlug) {
                let categoryId = categoriesMap.get(currentCategorySlug)?.id;
                
                // Fallback: If map isn't ready, fetch the category ID
                if (!categoryId) {
                    const catQuery = query(categoriesCollection, where("slug", "==", currentCategorySlug), limit(1));
                    const catSnap = await getDocs(catQuery);
                    if (!catSnap.empty) {
                        categoryId = catSnap.docs[0].id;
                    } else {
                         throw new Error("Category not found.");
                    }
                }
                
                // Add the category filter
                constraints.unshift(where("categoryIds", "array-contains", categoryId));
            }
            
            return query(postsCollection, ...constraints);
        }

        /**
         * Loads posts, with pagination and optional category filter.
         * @param {boolean} [isInitialLoad=false] - Is this the first page load?
         */
        async function loadPosts(isInitialLoad = false) {
            if (isInitialLoad) {
                lastVisiblePost = null; // Reset pagination
                blogGrid.innerHTML = ''; // Clear grid
                loader.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                noPostsMessage.classList.add('hidden');
                
                try {
                    currentQuery = await buildQuery(); // Build the query once for the page
                } catch(error) {
                    showError(error.message, error);
                    return;
                }
            }
            
            loadMoreBtn.classList.add('hidden');
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'Loading...';
            
            try {
                // 1. Build the paginated query
                let paginatedQuery;
                if (lastVisiblePost) {
                    paginatedQuery = query(currentQuery, limit(POSTS_PER_PAGE), startAfter(lastVisiblePost));
                } else {
                    paginatedQuery = query(currentQuery, limit(POSTS_PER_PAGE));
                }

                // 2. Execute the query
                const querySnapshot = await getDocs(paginatedQuery);

                // 3. Handle results
                if (isInitialLoad) {
                    loader.classList.add('hidden');
                }
                
                if (querySnapshot.empty) {
                    if (isInitialLoad) {
                        noPostsMessage.classList.remove('hidden');
                        noPostsMessage.innerHTML = '<p>No posts found in this category.</p>';
                    }
                    loadMoreBtn.classList.add('hidden');
                    return; // No more posts
                }

                // 4. Save the last visible post for the *next* page
                lastVisiblePost = querySnapshot.docs[querySnapshot.docs.length - 1];

                // 5. Render posts
                querySnapshot.forEach((doc) => {
                    const post = doc.data();
                    const postId = doc.id;
                    const postCard = document.createElement('a');
                    postCard.className = 'blog-card';
                    // Link to the post using its SLUG (or ID as fallback)
                    postCard.href = `post.html?slug=${post.slug || postId}`;

                    const postDate = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleDateString() : 'Just now';
                    
                    // Use placeholder if no feature image
                    const imageUrl = post.featureImage || 'https://placehold.co/600x400/0a192f/FFFFFF?text=Epplicon';
                    
                    // Create category tags (sanitized)
                    let tagsHtml = '';
                    if(post.categoryNames) {
                        post.categoryNames.slice(0, 2).forEach(name => { // Show max 2 tags
                            const sanitizedName = DOMPurify.sanitize(name);
                            tagsHtml += `<span class="blog-card-tag">${sanitizedName}</span>`;
                        });
                    }

                    // Sanitize user-generated content
                    const sanitizedTitle = DOMPurify.sanitize(post.title);
                    const sanitizedExcerpt = DOMPurify.sanitize(post.excerpt || 'Click to read more...');
                    const sanitizedImageUrl = DOMPurify.sanitize(imageUrl);
                    
                    postCard.innerHTML = `
                        <div class="blog-card-image">
                            <img src="${sanitizedImageUrl}" alt="${sanitizedTitle}" loading="lazy">
                        </div>
                        <div class="blog-card-content">
                            <div class="blog-card-tags">
                                ${tagsHtml}
                            </div>
                            <h3>${sanitizedTitle}</h3>
                            <p>${sanitizedExcerpt}</p>
                            <div class="blog-card-footer">
                                <span>${postDate}</span>
                            </div>
                        </div>
                    `;
                    blogGrid.appendChild(postCard);
                });
                
                // 6. Check if there are more posts
                if (querySnapshot.docs.length === POSTS_PER_PAGE) {
                    loadMoreBtn.classList.remove('hidden');
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'Load More Posts';
                } else {
                    loadMoreBtn.classList.add('hidden');
                }

            } catch (error) {
                showError(error.message, error);
            }
        }
        
        function showError(message, error = null) {
            console.error("Error fetching blog posts:", message, error);
            loader.classList.add('hidden');
            
            // Check for the "Missing Index" error and provide a helpful link
            if (error && error.code === 'failed-precondition') {
                 errorMessage.innerHTML = `<b>Firestore Error:</b> The required index for this query is missing.<br>
                 Please open the developer console (F12), find the error message, and click the link to create the index in Firebase.`;
                 console.error("Firestore Index Error: Click the link in the following error message to create the index:", error.message);
            } else {
                errorMessage.innerHTML = `<p style="color: var(--danger-color);">${message}</p>`;
            }
            errorMessage.classList.remove('hidden');
        }

        // --- Event Listeners ---
        loadMoreBtn.addEventListener('click', () => {
            loadPosts(false); // false = not initial load (pagination)
        });
        
        // ---
        // 0. START THE APPLICATION
        // ---
        initializeAppAndLoad();

    </script>

    <!-- Advanced UI Elements -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">
        <i class="fas fa-moon"></i>
    </button>
    <a href="#main-content" id="backToTop" class="back-to-top" aria-label="Back to top">
        <i class="fas fa-arrow-up"></i>
    </a>

    <!-- External JavaScript -->
    <script src="assets/js/nav-footer.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/animations.js"></script>
    <script src="assets/js/advanced.js"></script>

</body>
</html>