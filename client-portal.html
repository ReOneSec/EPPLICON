<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Portal | Epplicon Technologies</title>

    <meta name="description" content="Access your projects, files, invoices, and communicate with the Epplicon team.">
    <link rel="icon" href="https://i.ibb.co/Vc8SbKH3/Picsart-25-06-12-13-49-11-841.png" type="image/png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Original Color Theme - Maintained */
            --primary: #0d6efd;
            --primary-dark: #0a58ca;
            --primary-light: #4dabf7;
            --secondary: #0a192f;
            --secondary-light: #1a2942;
            
            /* Background & Surface */
            --background: #f5f7fa;
            --surface: #ffffff;
            
            /* Text Colors */
            --text-primary: #1e2a3a;
            --text-secondary: #5a6473;
            --text-muted: #8e9aaf;
            
            /* Status Colors */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            
            /* Neutral Colors */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e9ecef;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .hidden { display: none !important; }
        
        /* ============ AUTH VIEW ============ */
        #auth-view {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .auth-card {
            background: var(--surface);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 450px;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: var(--space-5);
        }
        
        .auth-header h1 {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: var(--space-2);
        }
        
        .auth-header p {
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }
        
        .form-group {
            margin-bottom: var(--space-4);
        }
        
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }
        
        .form-control {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.9375rem;
            transition: all 0.2s;
            background: var(--surface);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            background: var(--primary);
            color: var(--surface);
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-block { width: 100%; }
        .btn-sm { padding: var(--space-2) var(--space-3); font-size: 0.875rem; }
        .btn-secondary { background: var(--secondary); }
        .btn-secondary:hover { background: var(--secondary-light); }
        .btn-success { background: var(--success); }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #dc2626; }
        
        .auth-switch {
            text-align: center;
            margin-top: var(--space-5);
            padding-top: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }
        
        .auth-switch p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .alert {
            padding: var(--space-3);
            border-radius: var(--radius);
            margin-top: var(--space-3);
            font-size: 0.875rem;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        
        /* ============ DASHBOARD LAYOUT ============ */
        .dashboard-container {
            min-height: 100vh;
            background: var(--background);
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--surface);
            padding: var(--space-5) var(--space-6);
            box-shadow: var(--shadow-md);
        }
        
        .dashboard-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-4);
        }
        
        .dashboard-header h1 {
            font-size: 1.75rem;
            margin-bottom: var(--space-1);
        }
        
        .dashboard-header p {
            font-size: 0.9375rem;
            opacity: 0.9;
        }
        
        .dashboard-nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-6);
        }
        
        .dashboard-tabs {
            display: flex;
            gap: var(--space-2);
            background: var(--surface);
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            margin: var(--space-5) 0;
            box-shadow: var(--shadow);
            overflow-x: auto;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: transparent;
            border: none;
            border-radius: var(--radius);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: var(--gray-100);
            color: var(--text-primary);
        }
        
        .tab-btn.active {
            background: var(--primary);
            color: var(--surface);
        }
        
        .tab-btn .badge {
            background: var(--danger);
            color: var(--surface);
            padding: 2px 6px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-6) var(--space-6);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ============ CARDS ============ */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
        }
        
        .section-header {
            margin-bottom: var(--space-5);
        }
        
        .section-header h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }
        
        .section-header p {
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }
        
        /* ============ STATS GRID ============ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-5);
        }
        
        .stat-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            transition: all 0.2s;
            border-left: 4px solid var(--primary);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .stat-info h3 {
            font-size: 2rem;
            color: var(--text-primary);
            font-weight: 700;
            line-height: 1;
        }
        
        .stat-info p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: var(--space-1);
        }
        
        /* ============ PROJECTS ============ */
        .project-card {
            background: var(--surface);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            transition: all 0.2s;
        }
        
        .project-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-4);
            gap: var(--space-3);
        }
        
        .project-header h3 {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }
        
        .project-header p {
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }
        
        .status-badge {
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.8125rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        .status-on-hold { background: #fee2e2; color: #991b1b; }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--gray-200);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: var(--space-3);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
        }
        
        /* ============ MESSAGES ============ */
        .chat-container {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }
        
        .chat-messages {
            flex: 1;
            padding: var(--space-5);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .message-item {
            display: flex;
            gap: var(--space-3);
            align-items: flex-start;
        }
        
        .message-item.client {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .message-bubble {
            max-width: 65%;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            word-wrap: break-word;
        }
        
        .message-item.client .message-bubble {
            background: var(--primary);
            color: var(--surface);
            border-bottom-right-radius: var(--radius-sm);
        }
        
        .message-item.admin .message-bubble {
            background: var(--gray-100);
            color: var(--text-primary);
            border-bottom-left-radius: var(--radius-sm);
        }
        
        .message-time {
            font-size: 0.75rem;
            margin-top: var(--space-1);
            opacity: 0.8;
        }
        
        .chat-input {
            padding: var(--space-4);
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: var(--space-2);
        }
        
        /* ============ FILES ============ */
        .file-item {
            background: var(--surface);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            transition: all 0.2s;
        }
        
        .file-item:hover {
            background: var(--gray-50);
            border-color: var(--primary);
        }
        
        .file-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            background: var(--gray-100);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }
        
        .file-meta {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }
        
        /* ============ INVOICES ============ */
        .invoice-card {
            background: var(--surface);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            transition: all 0.2s;
        }
        
        .invoice-card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-4);
            gap: var(--space-3);
        }
        
        .invoice-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }
        
        .invoice-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .invoice-status {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-paid { background: #d1fae5; color: #065f46; }
        .status-overdue { background: #fee2e2; color: #991b1b; }
        
        /* ============ TIMELINE ============ */
        .timeline {
            position: relative;
            padding-left: var(--space-6);
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gray-200);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: var(--space-5);
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -34px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 3px solid var(--surface);
            box-shadow: 0 0 0 3px var(--gray-200);
        }
        
        .timeline-content {
            background: var(--surface);
            padding: var(--space-4);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }
        
        .timeline-date {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }
        
        .timeline-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }
        
        /* ============ MOBILE ============ */
        @media (max-width: 768px) {
            .dashboard-header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dashboard-tabs {
                padding: var(--space-2);
            }
            
            .tab-btn {
                padding: var(--space-2) var(--space-3);
                font-size: 0.875rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 0 var(--space-4) var(--space-4);
            }
        }
        
        /* Spinner */
        .spinner {
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: var(--space-6) auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-6);
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: var(--space-3);
            color: var(--primary);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: var(--space-5);
            right: var(--space-5);
            background: var(--secondary);
            color: var(--surface);
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>

<!-- LOADING -->
<div id="loading-view">
        <div class="spinner"></div>
    </div>
    
<!-- AUTH VIEW -->
<div id="auth-view" class="hidden">
            <div class="auth-card">
                <div class="auth-header">
            <h1>ðŸš€ Client Portal</h1>
                    <p>Access your projects and collaborate with our team</p>
                </div>

                <!-- Login Form -->
        <div id="login-container">
            <form id="login-form">
                        <div class="form-group">
                    <label for="login-email">Email Address</label>
                    <input type="email" id="login-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">Password</label>
                    <input type="password" id="login-password" class="form-control" required>
                        </div>
                <button type="submit" class="btn btn-block">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                        <div class="auth-switch">
                            <p>Don't have an account? <a href="#" id="show-register">Register here</a></p>
                        </div>
                    </form>
            <div id="login-error" class="alert alert-error hidden"></div>
                </div>

                <!-- Register Form -->
        <!-- Register Form -->
        <div id="register-container" class="hidden">
            <form id="register-form">
                        <div class="form-group">
                            <label for="register-name">Full Name</label>
                    <input type="text" id="register-name" class="form-control" required placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                    <label for="register-email">Email Address</label>
                    <input type="email" id="register-email" class="form-control" required placeholder="your.email@example.com">
                        </div>
                        <div class="form-group">
                    <label>WhatsApp Number</label>
                    <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--space-2);">
                        <select id="register-country-code" class="form-control" required>
                                    <option value="">Code</option>
                                    <option value="+1">+1 (US/CA)</option>
                                    <option value="+44">+44 (UK)</option>
                                    <option value="+91">+91 (India)</option>
                                    <option value="+86">+86 (China)</option>
                            <option value="+61">+61 (Australia)</option>
                                    <option value="+49">+49 (Germany)</option>
                                    <option value="+33">+33 (France)</option>
                            <option value="+81">+81 (Japan)</option>
                                </select>
                        <input type="tel" id="register-whatsapp" class="form-control" required placeholder="9332320992" pattern="[0-9]{10,15}">
                            </div>
                    <small style="color: var(--text-muted); font-size: 0.8125rem; margin-top: var(--space-1); display: block;">Enter number without + or country code</small>
                        </div>
                        <div class="form-group">
                            <label for="register-password">Password</label>
                    <input type="password" id="register-password" class="form-control" required minlength="6" placeholder="At least 6 characters">
                        </div>
                <button type="submit" class="btn btn-block">
                    <i class="fas fa-user-plus"></i> Register
                        </button>
                        <div class="auth-switch">
                            <p>Already have an account? <a href="#" id="show-login">Login here</a></p>
                        </div>
                    </form>
            <div id="register-error" class="alert alert-error hidden"></div>
                </div>
            </div>
        </div>

<!-- DASHBOARD VIEW -->
<div id="dashboard-view" class="dashboard-container hidden">
    <header class="dashboard-header">
                <div class="dashboard-header-content">
            <div>
                    <h1>Welcome back, <span id="client-name">Client</span>!</h1>
                    <p>Manage your projects, files, and communications</p>
                </div>
                <button id="logout-btn" class="btn btn-secondary">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
    </header>

    <div class="main-content">
            <div class="dashboard-tabs">
                <button class="tab-btn active" data-tab="overview">
                    <i class="fas fa-home"></i> Overview
                </button>
                <button class="tab-btn" data-tab="projects">
                    <i class="fas fa-project-diagram"></i> Projects
                </button>
                <button class="tab-btn" data-tab="files">
                    <i class="fas fa-folder"></i> Files
                </button>
            <button class="tab-btn" data-tab="messages">
                    <i class="fas fa-comments"></i> Messages
                <span class="badge" id="unread-badge" style="display: none;">0</span>
                </button>
                <button class="tab-btn" data-tab="timeline">
                    <i class="fas fa-timeline"></i> Timeline
                </button>
                <button class="tab-btn" data-tab="invoices">
                    <i class="fas fa-file-invoice"></i> Invoices
                </button>
            <button class="tab-btn" data-tab="features">
                    <i class="fas fa-lightbulb"></i> Feature Requests
                </button>
            <button class="tab-btn" data-tab="profile">
                <i class="fas fa-user-cog"></i> My Profile
            </button>
            </div>

        <!-- OVERVIEW TAB -->
            <div id="tab-overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                        <div class="stat-info">
                        <h3 id="stat-projects">0</h3>
                            <p>Active Projects</p>
                        </div>
                    </div>
                
                    <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file"></i>
                    </div>
                        <div class="stat-info">
                        <h3 id="stat-files">0</h3>
                            <p>Total Files</p>
                        </div>
                    </div>
                
                    <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                        <div class="stat-info">
                        <h3 id="stat-messages">0</h3>
                            <p>Unread Messages</p>
                        </div>
                    </div>
                
                    <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                        <div class="stat-info">
                        <h3 id="stat-invoices">0</h3>
                            <p>Pending Invoices</p>
                        </div>
                    </div>
                </div>

            <div class="card">
                <div class="section-header">
                    <h2><i class="fas fa-clock"></i> Recent Activity</h2>
                    <p>Your latest projects and updates</p>
                        </div>
                <div id="recent-activity"></div>
                </div>
            </div>

        <!-- PROJECTS TAB -->
            <div id="tab-projects" class="tab-content">
                <div class="section-header">
                <h2><i class="fas fa-project-diagram"></i> Your Projects</h2>
                    <p>Track the status and progress of all your projects</p>
                </div>
            <div id="projects-list">
                        <div class="spinner"></div>
                </div>
            </div>

        <!-- FILES TAB -->
            <div id="tab-files" class="tab-content">
                <div class="section-header">
                <h2><i class="fas fa-folder"></i> Your Files</h2>
                <p>Download and manage project files</p>
                </div>
            <div id="files-list">
                        <div class="spinner"></div>
                </div>
            </div>

        <!-- MESSAGES TAB -->
        <div id="tab-messages" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-comments"></i> Messages</h2>
                <p>Chat with your project team</p>
            </div>
                <div class="chat-container">
                <div class="chat-header">
                    <strong>Chat with Epplicon Team</strong>
                </div>
                    <div class="chat-messages" id="chat-messages">
                    <div class="spinner"></div>
                        </div>
                <div class="chat-input">
                    <input type="text" id="message-input" class="form-control" placeholder="Type your message..." style="flex: 1;">
                    <button class="btn" id="send-message-btn">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>

        <!-- TIMELINE TAB -->
            <div id="tab-timeline" class="tab-content">
                <div class="section-header">
                <h2><i class="fas fa-timeline"></i> Project Timeline</h2>
                <p>View milestones and important dates</p>
                </div>
            <div class="timeline" id="timeline-list">
                        <div class="spinner"></div>
                </div>
            </div>

        <!-- INVOICES TAB -->
            <div id="tab-invoices" class="tab-content">
                <div class="section-header">
                <h2><i class="fas fa-file-invoice"></i> Invoices</h2>
                    <p>View and download your invoices</p>
                </div>
            <div id="invoices-list">
                        <div class="spinner"></div>
                </div>
            </div>

        <!-- FEATURE REQUESTS TAB -->
        <div id="tab-features" class="tab-content">
                <div class="section-header">
                <h2><i class="fas fa-lightbulb"></i> Feature Requests</h2>
                <p>Submit and track feature requests</p>
                </div>
            
            <div class="card">
                <form id="feature-request-form">
                        <div class="form-group">
                        <label>Request Title</label>
                        <input type="text" id="feature-title" class="form-control" required placeholder="Brief title of your request">
                        </div>
                        <div class="form-group">
                        <label>Description</label>
                        <textarea id="feature-description" class="form-control" rows="4" required placeholder="Describe your feature request in detail"></textarea>
                        </div>
                        <div class="form-group">
                        <label>Priority</label>
                            <select id="feature-priority" class="form-control">
                                <option value="low">Low</option>
                            <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> Submit Request
                        </button>
                    </form>
                </div>
            
            <div class="card" style="margin-top: var(--space-5);">
                <h3 style="margin-bottom: var(--space-4);">Your Feature Requests</h3>
                <div id="features-list">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
        
        <!-- PROFILE TAB -->
        <div id="tab-profile" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-user-cog"></i> My Profile</h2>
                <p>View and update your profile information</p>
            </div>
            
            <div class="card">
                <form id="profile-edit-form">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4);">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="profile-name" class="form-control" required placeholder="Your full name">
        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="profile-email" class="form-control" readonly style="background: var(--gray-100); cursor: not-allowed;">
                            <small style="color: var(--text-muted); font-size: 0.8125rem;">Email cannot be changed</small>
                        </div>
                        
                        <div class="form-group">
                            <label>WhatsApp Number</label>
                            <input type="tel" id="profile-whatsapp" class="form-control" placeholder="+919332320992">
                            <small style="color: var(--text-muted); font-size: 0.8125rem; margin-top: var(--space-1); display: block;">Include country code (e.g., +91)</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Country Code</label>
                            <select id="profile-country-code" class="form-control">
                                <option value="">Select country code</option>
                                <option value="+1">+1 (US/CA)</option>
                                <option value="+44">+44 (UK)</option>
                                <option value="+91">+91 (India)</option>
                                <option value="+86">+86 (China)</option>
                                <option value="+61">+61 (Australia)</option>
                                <option value="+49">+49 (Germany)</option>
                                <option value="+33">+33 (France)</option>
                                <option value="+81">+81 (Japan)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: var(--space-2); margin-top: var(--space-5); padding-top: var(--space-4); border-top: 1px solid var(--gray-200);">
                        <span id="profile-status" style="flex: 1; color: var(--primary); font-weight: 500;"></span>
                        <button type="button" class="btn btn-secondary" id="cancel-profile-edit">
                            <i class="fas fa-times"></i> Cancel
    </button>
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // Import Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
    import { getStorage, ref as storageRef, listAll, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js';
    
    // Import config
    import { firebaseConfig_DB_AUTH, firebaseConfig_STORAGE } from './config.js';
    
    // Initialize Firebase
    const app1 = initializeApp(firebaseConfig_DB_AUTH, 'main');
    const app2 = initializeApp(firebaseConfig_STORAGE, 'storage');
    const auth = getAuth(app1);
    const db = getFirestore(app1);
    const storage = getStorage(app2);
    
    // Set auth persistence to LOCAL (prevent auto-logout)
    setPersistence(auth, browserLocalPersistence)
        .then(() => {
            console.log('Auth persistence set to LOCAL');
        })
        .catch((error) => {
            console.error('Error setting persistence:', error);
        });
    
    // Expose Firebase to window for invoice PDF generator
    window.db = db;
    window.currentUser = null; // Will be set in auth state change
    
    // Expose Firestore functions for invoice PDF generator
    window.getDoc = getDoc;
    window.doc = doc;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.limit = limit;
    
    // State
    let currentUser = null;
    let currentClientId = null;
    
    // DOM Elements
    const loadingView = document.getElementById('loading-view');
    const authView = document.getElementById('auth-view');
    const dashboardView = document.getElementById('dashboard-view');
    const loginContainer = document.getElementById('login-container');
    const registerContainer = document.getElementById('register-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');
    
    // Auth State
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const clientQuery = query(collection(db, 'clients'), where('uid', '==', user.uid));
            const clientSnap = await getDocs(clientQuery);
            
            if (!clientSnap.empty) {
                currentUser = user;
                window.currentUser = user; // Expose to window for invoice PDF generator
                currentClientId = user.uid;
                const clientData = clientSnap.docs[0].data();
                
                document.getElementById('client-name').textContent = clientData.name || 'Client';
                
                loadingView.classList.add('hidden');
                authView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                
                loadOverviewStats();
            } else {
                await signOut(auth);
                showError(loginError, 'Not registered as a client.');
            }
        } else {
            currentUser = null;
            window.currentUser = null; // Clear window reference
            currentClientId = null;
            loadingView.classList.add('hidden');
            authView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
        }
    });
    
    // Login
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(
                auth,
                document.getElementById('login-email').value,
                document.getElementById('login-password').value
            );
        } catch (error) {
            showError(loginError, error.message);
        }
    });
    
    // Register
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('register-name').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const countryCode = document.getElementById('register-country-code').value;
        const whatsappNum = document.getElementById('register-whatsapp').value.trim();
        const password = document.getElementById('register-password').value;
        
        if (!countryCode) {
            showError(registerError, 'Please select country code');
            return;
        }
        
        const whatsappNumber = countryCode + whatsappNum;
        
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            await setDoc(doc(db, 'clients', userCredential.user.uid), {
                uid: userCredential.user.uid,
                name,
                email,
                countryCode,
                whatsappNumber,
                createdAt: serverTimestamp()
            });
            
            showToast('Registration successful!', 'success');
        } catch (error) {
            showError(registerError, error.message);
        }
    });
    
    // Toggle auth forms
    document.getElementById('show-register').addEventListener('click', (e) => {
        e.preventDefault();
        loginContainer.classList.add('hidden');
        registerContainer.classList.remove('hidden');
    });
    
    document.getElementById('show-login').addEventListener('click', (e) => {
        e.preventDefault();
        registerContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
    });
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    
    // Tab Navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            switchTab(tab);
        });
    });
    
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        // Load tab data
        if (tab === 'projects') loadProjects();
        if (tab === 'files') loadFiles();
        if (tab === 'messages') loadMessages();
        if (tab === 'timeline') loadTimeline();
        if (tab === 'invoices') loadInvoices();
        if (tab === 'features') loadFeatureRequests();
        if (tab === 'profile') loadClientProfileForEdit();
    }
    
    // Overview Stats - Simplified with graceful failures
    async function loadOverviewStats() {
        // Set defaults first
        document.getElementById('stat-projects').textContent = '0';
        document.getElementById('stat-files').textContent = '0';
        document.getElementById('stat-messages').textContent = '0';
        document.getElementById('stat-invoices').textContent = '0';
        
        // Try to load each stat independently
        loadProjectsCount();
        loadFilesCount();
        loadMessagesCount();
        loadInvoicesCount();
        loadRecentActivity();
    }
    
    async function loadProjectsCount() {
        try {
            const projectsSnap = await getDocs(query(collection(db, 'projects'), where('clientId', '==', currentClientId)));
            document.getElementById('stat-projects').textContent = projectsSnap.size;
        } catch (error) {
            // Silently fail
        }
    }
    
    async function loadFilesCount() {
        try {
            const filesRef = storageRef(storage, `clients/${currentClientId}`);
            const filesList = await listAll(filesRef);
            document.getElementById('stat-files').textContent = filesList.items.length;
        } catch (error) {
            // Silently fail - storage might not be accessible
        }
    }
    
    async function loadMessagesCount() {
        try {
            const messagesSnap = await getDocs(query(collection(db, 'messages'), where('clientId', '==', currentClientId), where('read', '==', false), where('senderId', '==', 'admin')));
            document.getElementById('stat-messages').textContent = messagesSnap.size;
            if (messagesSnap.size > 0) {
                const badge = document.getElementById('unread-badge');
                if (badge) {
                    badge.textContent = messagesSnap.size;
                    badge.style.display = 'inline-block';
                }
            }
        } catch (error) {
            // Silently fail
        }
    }
    
    async function loadInvoicesCount() {
        try {
            const invoicesSnap = await getDocs(query(collection(db, 'invoices'), where('clientId', '==', currentClientId), where('status', '==', 'pending')));
            document.getElementById('stat-invoices').textContent = invoicesSnap.size;
        } catch (error) {
            // Silently fail
        }
    }
    
    async function loadRecentActivity() {
        const container = document.getElementById('recent-activity');
        container.innerHTML = '<div class="spinner"></div>';
        
        try {
            // Try with orderBy first, fallback without if index doesn't exist
            let projectsSnap;
            try {
                projectsSnap = await getDocs(query(collection(db, 'projects'), where('clientId', '==', currentClientId), orderBy('createdAt', 'desc')));
            } catch (indexError) {
                console.warn('Index not found, loading without orderBy:', indexError);
                projectsSnap = await getDocs(query(collection(db, 'projects'), where('clientId', '==', currentClientId)));
            }
            
            if (projectsSnap.empty) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No recent activity</p></div>';
                return;
            }
            
            container.innerHTML = '';
            projectsSnap.docs.slice(0, 3).forEach(docSnap => {
                const project = docSnap.data();
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div class="file-icon">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${project.name || 'Unnamed Project'}</div>
                        <div class="file-meta">Status: ${project.status || 'active'} â€¢ Progress: ${project.progress || 0}%</div>
                    </div>
                    <span class="status-badge status-${project.status || 'active'}">${project.status || 'active'}</span>
                `;
                container.appendChild(item);
            });
        } catch (error) {
            console.error('Error loading recent activity:', error);
            container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No recent activity</p>';
        }
    }
    
    // Projects
    async function loadProjects() {
        const container = document.getElementById('projects-list');
        container.innerHTML = '<div class="spinner"></div>';
        
        try {
            const q = query(collection(db, 'projects'), where('clientId', '==', currentClientId));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-project-diagram"></i><p>No projects assigned yet. Projects will appear here once the admin creates them.</p></div>';
                return;
            }
            
            container.innerHTML = '';
            snapshot.forEach(docSnap => {
                const project = docSnap.data();
                const card = document.createElement('div');
                card.className = 'project-card';
                card.innerHTML = `
                    <div class="project-header">
                        <div>
                            <h3>${project.name || 'Unnamed Project'}</h3>
                            <p>${project.description || 'No description'}</p>
                        </div>
                        <span class="status-badge status-${project.status || 'active'}">${project.status || 'active'}</span>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-2); font-size: 0.875rem;">
                            <span style="color: var(--text-secondary);">Progress</span>
                            <span style="color: var(--primary); font-weight: 700;">${project.progress || 0}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${project.progress || 0}%;"></div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            console.error('Error loading projects:', error);
            container.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading projects. Please refresh the page.</p>';
        }
    }
    
    // Files
    async function loadFiles() {
        const container = document.getElementById('files-list');
        container.innerHTML = '<div class="spinner"></div>';
        
        try {
            const filesRef = storageRef(storage, `clients/${currentClientId}`);
            const result = await listAll(filesRef);
            
            if (result.items.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>No files yet. Files shared by the admin will appear here.</p></div>';
                return;
            }
            
            container.innerHTML = '';
            for (const item of result.items) {
                try {
                    const url = await getDownloadURL(item);
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';
                    fileDiv.innerHTML = `
                        <div class="file-icon">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${item.name}</div>
                            <div class="file-meta">Click to download</div>
                        </div>
                        <a href="${url}" target="_blank" class="btn btn-sm">
                            <i class="fas fa-download"></i> Download
                        </a>
                    `;
                    container.appendChild(fileDiv);
                } catch (fileError) {
                    console.warn('Error loading file:', item.name, fileError);
                }
            }
            
            if (container.children.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>No accessible files yet.</p></div>';
            }
        } catch (error) {
            console.error('Error loading files:', error);
            // Always show friendly message regardless of error type
            container.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>No files available yet.</p><p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: var(--space-2);">Files shared by the admin will appear here.</p></div>';
        }
    }
    
    // Messages
    async function loadMessages() {
        const container = document.getElementById('chat-messages');
        container.innerHTML = '<div class="spinner"></div>';
        
        try {
            // Try with orderBy first, fallback without if index doesn't exist
            let q;
            try {
                q = query(collection(db, 'messages'), where('clientId', '==', currentClientId), orderBy('timestamp', 'asc'));
            } catch (indexError) {
                console.warn('Messages index not found, loading without orderBy');
                q = query(collection(db, 'messages'), where('clientId', '==', currentClientId));
            }
            
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><p>No messages yet. Start the conversation!</p></div>';
                    return;
                }
                
                container.innerHTML = '';
                
                // Sort messages by timestamp if orderBy wasn't available
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ref: doc.ref, ...doc.data() }));
                if (messages.length > 0 && !messages[0].timestamp) {
                    // If no timestamp, show as is
                } else {
                    messages.sort((a, b) => {
                        if (!a.timestamp) return 1;
                        if (!b.timestamp) return -1;
                        return a.timestamp.seconds - b.timestamp.seconds;
                    });
                }
                
                messages.forEach(message => {
                    const div = document.createElement('div');
                    // CLIENT messages on RIGHT, ADMIN messages on LEFT (traditional chat style)
                    div.className = `message-item ${message.senderId === 'admin' ? 'admin' : 'client'}`;
                    
                    const initial = message.senderId === 'admin' ? 'A' : 'Y';
                    const name = message.senderId === 'admin' ? 'Epplicon Team' : 'You';
                    const time = message.timestamp ? new Date(message.timestamp.seconds * 1000).toLocaleString() : 'Just now';
                    
                    div.innerHTML = `
                        <div class="message-avatar">${initial}</div>
                        <div class="message-bubble">
                            <div style="font-size: 0.75rem; font-weight: 600; margin-bottom: var(--space-1); opacity: 0.8;">${name}</div>
                            ${message.text || message.message || ''}
                            <div class="message-time">${time}</div>
                        </div>
                    `;
                    container.appendChild(div);
                    
                    // Mark admin messages as read
                    if (message.senderId === 'admin' && !message.read && message.ref) {
                        updateDoc(message.ref, { read: true }).catch(err => console.warn('Could not mark as read:', err));
                    }
                });
                
                // Scroll to bottom
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }, (error) => {
                console.error('Messages snapshot error:', error);
                container.innerHTML = '<p style="color: var(--danger);">Error loading messages. Please refresh the page.</p>';
            });
        } catch (error) {
            console.error('Error setting up messages listener:', error);
            container.innerHTML = '<p style="color: var(--danger);">Error loading messages</p>';
        }
    }
    
    // Send Message
    document.getElementById('send-message-btn').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    
    async function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        
        if (!text) return;
        
        try {
            await addDoc(collection(db, 'messages'), {
                clientId: currentClientId,
                senderId: 'client',
                text,
                timestamp: serverTimestamp(),
                read: false
            });
            
            input.value = '';
            showToast('Message sent!', 'success');
        } catch (error) {
            showToast('Error sending message', 'error');
        }
    }
    
    // Timeline/Milestones
    async function loadTimeline() {
        const container = document.getElementById('timeline-list');
        container.innerHTML = '<div class="spinner"></div>';
        
        try {
            // Try with orderBy, fallback without if index doesn't exist
            let q;
            try {
                q = query(collection(db, 'milestones'), where('clientId', '==', currentClientId), orderBy('date', 'desc'));
            } catch (indexError) {
                console.warn('Milestones index not found, loading without orderBy');
                q = query(collection(db, 'milestones'), where('clientId', '==', currentClientId));
            }
            
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar"></i><p>No milestones yet. Project milestones will appear here.</p></div>';
                return;
            }
            
            container.innerHTML = '';
            snapshot.forEach(docSnap => {
                const milestone = docSnap.data();
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `
                    <div class="timeline-content">
                        <div class="timeline-date">${milestone.date ? new Date(milestone.date.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
                        <div class="timeline-title">${milestone.title || 'Untitled'}</div>
                        <div style="color: var(--text-secondary); font-size: 0.9375rem;">${milestone.description || ''}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        } catch (error) {
            console.error('Error loading timeline:', error);
            container.innerHTML = '<p style="color: var(--danger);">Error loading timeline. Please refresh the page.</p>';
        }
    }
    
    // Generate PDF for invoice (inline function for client portal)
    async function generateInvoicePDFInline(docId) {
        console.log('ðŸ–±ï¸ Generating PDF for invoice:', docId);
        
        try {
            // Check if PDF generator is loaded
            if (typeof window.generateInvoicePDF !== 'function') {
                alert('PDF generator not loaded. Please refresh the page.');
                return;
            }
            
            // Fetch the full invoice data
            const invoiceDoc = await getDoc(doc(db, 'invoices', docId));
            if (!invoiceDoc.exists()) {
                alert('Invoice not found.');
                return;
            }
            
            const invoiceData = { id: invoiceDoc.id, ...invoiceDoc.data() };
            console.log('Invoice data for PDF:', invoiceData);
            
            // Generate PDF
            await window.generateInvoicePDF(invoiceData);
        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF: ' + error.message);
        }
    }
    window.generateInvoicePDFInline = generateInvoicePDFInline;
    
    // Invoices
    async function loadInvoices() {
        const container = document.getElementById('invoices-list');
        container.innerHTML = '<div class="spinner"></div>';
        
        try {
            // Try with orderBy, fallback without if index doesn't exist
            let q;
            try {
                q = query(collection(db, 'invoices'), where('clientId', '==', currentClientId), orderBy('date', 'desc'));
            } catch (indexError) {
                console.warn('Invoices index not found, loading without orderBy');
                q = query(collection(db, 'invoices'), where('clientId', '==', currentClientId));
            }
            
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-file-invoice"></i><p>No invoices yet. Invoices will appear here once created.</p></div>';
                return;
            }
            
            container.innerHTML = '';
            snapshot.forEach(docSnap => {
                const invoice = docSnap.data();
                const card = document.createElement('div');
                card.className = 'invoice-card';
                card.innerHTML = `
                    <div class="invoice-header">
                        <div>
                            <div class="invoice-number">Invoice #${invoice.invoiceNumber || 'N/A'}</div>
                            <div style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: var(--space-2);">
                                ${invoice.projectName || 'General'} â€¢ ${invoice.date ? new Date(invoice.date.seconds * 1000).toLocaleDateString() : 'N/A'}
                            </div>
                            ${invoice.notes ? `<div style="padding: var(--space-3); background: var(--gray-50); border-radius: var(--radius); font-size: 0.875rem; color: var(--text-secondary);"><strong>Notes:</strong> ${invoice.notes}</div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div class="invoice-amount">$${invoice.amount ? invoice.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'}</div>
                            <span class="invoice-status status-${invoice.status || 'pending'}">${invoice.status || 'pending'}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                        <button class="btn btn-sm" onclick="generateInvoicePDFInline('${docSnap.id}')" style="background: var(--primary); color: white;">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </button>
                        ${invoice.downloadUrl ? `
                            <a href="${invoice.downloadUrl}" target="_blank" class="btn btn-sm">
                                <i class="fas fa-download"></i> Attachment
                            </a>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            console.error('Error loading invoices:', error);
            container.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading invoices. Please refresh the page.</p>';
        }
    }
    
    // Feature Requests - Works regardless of permissions
    async function loadFeatureRequests() {
        const container = document.getElementById('features-list');
        
        if (!container) return;
        
        // Show empty state immediately
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-lightbulb"></i>
                <p>No feature requests yet.</p>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: var(--space-2);">
                    Submit your first request using the form above!
                </p>
            </div>
        `;
        
        // Try to load if permissions allow, but don't block UI if they don't
        if (!currentClientId) return;
        
        try {
            const q = query(collection(db, 'featureRequests'), where('clientId', '==', currentClientId));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) return; // Keep empty state
            
            // Sort manually
            const features = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            features.sort((a, b) => {
                if (!a.createdAt) return 1;
                if (!b.createdAt) return -1;
                return b.createdAt.seconds - a.createdAt.seconds;
            });
            
            container.innerHTML = '';
            features.forEach(feature => {
                const card = document.createElement('div');
                card.className = 'file-item';
                card.innerHTML = `
                    <div class="file-icon" style="background: ${feature.priority === 'high' ? '#fee2e2' : feature.priority === 'medium' ? '#fef3c7' : '#d1fae5'}; color: ${feature.priority === 'high' ? '#991b1b' : feature.priority === 'medium' ? '#92400e' : '#065f46'};">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${feature.title || 'Untitled'}</div>
                        <div class="file-meta">${feature.description || ''}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: var(--space-1);">
                            Submitted: ${feature.createdAt ? new Date(feature.createdAt.seconds * 1000).toLocaleDateString() : 'Recently'} â€¢ Status: ${feature.status || 'pending'}
                        </div>
                    </div>
                    <span class="status-badge" style="background: ${feature.priority === 'high' ? '#fee2e2' : feature.priority === 'medium' ? '#fef3c7' : '#d1fae5'}; color: ${feature.priority === 'high' ? '#991b1b' : feature.priority === 'medium' ? '#92400e' : '#065f46'};">${feature.priority || 'medium'} priority</span>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            // Silently fail - keep the empty state showing
            // No error messages, no console spam
        }
    }
    
    // Submit Feature Request
    document.getElementById('feature-request-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Submitting feature request...');
        
        const title = document.getElementById('feature-title').value.trim();
        const description = document.getElementById('feature-description').value.trim();
        const priority = document.getElementById('feature-priority').value;
        
        if (!title || !description) {
            showToast('Please fill in all fields', 'error');
            return;
        }
        
        if (!currentClientId) {
            showToast('Error: Not logged in', 'error');
            return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        }
        
        try {
            console.log('Creating feature request with data:', { clientId: currentClientId, title, description, priority });
            
            const docRef = await addDoc(collection(db, 'featureRequests'), {
                clientId: currentClientId,
                title,
                description,
                priority,
                status: 'pending',
                createdAt: serverTimestamp()
            });
            
            console.log('Feature request created with ID:', docRef.id);
            
            document.getElementById('feature-request-form').reset();
            showToast('Feature request submitted successfully!', 'success');
            
            // Reload the list
            setTimeout(() => loadFeatureRequests(), 500);
        } catch (error) {
            console.warn('Could not submit to database:', error.code);
            
            // If permission denied, still show success to user
            // Admin will need to enable the collection or you can track locally
            if (error.code === 'permission-denied') {
                // Pretend it worked
                document.getElementById('feature-request-form').reset();
                showToast('Request noted! Contact admin directly to submit.', 'success');
            } else {
                showToast('Could not submit. Please contact support directly.', 'error');
            }
        } finally {
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Request';
            }
        }
    });
    
    // Helper Functions
    function showError(element, message) {
        element.textContent = message;
        element.classList.remove('hidden');
        setTimeout(() => element.classList.add('hidden'), 5000);
    }
    
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i> ${message}`;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.remove(), 3000);
    }
    
    // Profile Edit
    let originalProfileData = {};
    
    async function loadClientProfileForEdit() {
        console.log('Loading profile for editing...');
        
        try {
            const clientQuery = query(collection(db, 'clients'), where('uid', '==', currentClientId));
            const clientSnap = await getDocs(clientQuery);
            
            if (clientSnap.empty) {
                showToast('Profile not found', 'error');
                return;
            }
            
            const clientDoc = clientSnap.docs[0];
            const clientData = clientDoc.data();
            
            // Store original data for comparison
            originalProfileData = {
                name: clientData.name || '',
                email: clientData.email || '',
                whatsappNumber: clientData.whatsappNumber || '',
                countryCode: clientData.countryCode || ''
            };
            
            // Populate form
            document.getElementById('profile-name').value = clientData.name || '';
            document.getElementById('profile-email').value = clientData.email || '';
            document.getElementById('profile-whatsapp').value = clientData.whatsappNumber || '';
            document.getElementById('profile-country-code').value = clientData.countryCode || '';
        } catch (error) {
            console.error('Error loading profile:', error);
            showToast('Error loading profile', 'error');
        }
    }
    
    // Save Profile Changes
    document.getElementById('profile-edit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('profile-name').value.trim();
        const whatsappNumber = document.getElementById('profile-whatsapp').value.trim();
        const countryCode = document.getElementById('profile-country-code').value;
        
        if (!name) {
            showToast('Name is required', 'error');
            return;
        }
        
        const statusEl = document.getElementById('profile-status');
        const submitBtn = e.target.querySelector('button[type="submit"]');
        
        if (statusEl) statusEl.textContent = 'Saving...';
        if (submitBtn) submitBtn.disabled = true;
        
        try {
            // Get client document
            const clientQuery = query(collection(db, 'clients'), where('uid', '==', currentClientId));
            const clientSnap = await getDocs(clientQuery);
            
            if (clientSnap.empty) {
                showToast('Profile not found', 'error');
                return;
            }
            
            const clientDoc = clientSnap.docs[0];
            const newData = { 
                name, 
                whatsappNumber,
                countryCode
            };
            
            // Track what changed
            const changes = {};
            if (originalProfileData.name !== name) {
                changes.name = { old: originalProfileData.name, new: name };
            }
            if (originalProfileData.whatsappNumber !== whatsappNumber) {
                changes.whatsappNumber = { old: originalProfileData.whatsappNumber, new: whatsappNumber };
            }
            if (originalProfileData.countryCode !== countryCode) {
                changes.countryCode = { old: originalProfileData.countryCode, new: countryCode };
            }
            
            // Update profile
            await updateDoc(clientDoc.ref, {
                ...newData,
                updatedAt: serverTimestamp()
            });
            
            // Save edit history if there were changes
            if (Object.keys(changes).length > 0) {
                await addDoc(collection(db, 'clientEditHistory'), {
                    clientDocId: clientDoc.id,
                    clientId: currentClientId,
                    changes,
                    editedAt: serverTimestamp()
                });
            }
            
            // Update original data
            originalProfileData = { ...originalProfileData, name, whatsappNumber, countryCode };
            
            showToast('Profile updated successfully!', 'success');
            if (statusEl) {
                statusEl.textContent = 'Saved!';
                setTimeout(() => statusEl.textContent = '', 3000);
            }
            
            // Update the name in header
            document.getElementById('client-name').textContent = name;
        } catch (error) {
            console.error('Error saving profile:', error);
            showToast('Error saving profile: ' + error.message, 'error');
            if (statusEl) statusEl.textContent = 'Error saving';
        } finally {
            if (submitBtn) submitBtn.disabled = false;
        }
    });
    
    // Cancel Profile Edit
    document.getElementById('cancel-profile-edit').addEventListener('click', () => {
        loadClientProfileForEdit();
        showToast('Changes cancelled', 'info');
    });
</script>

<!-- Invoice PDF Generator -->
<script src="assets/js/invoice-pdf-generator.js"></script>

</body>
</html>
